---
title: "10-years of declining TB case notification rates in Blantyre, Malawi"

subtitle: "An analysis of systematic enhanced surveillance and active case finding interventions"

author: |
  | Marriott Nliwasa, Emily Webb, Mcewen Khundi, Pete J Dodd, Hussein Twabi, Peter MacPherson, Elizabeth L Corbett
  |
  | Liverpool School of Tropical Medicine, Liverpool, UK
  | Malawi-Liverpool-Wellcome Clinical Research Programme, Blantyre, Malawi
  |

date: | 
  | `r format(Sys.time(), "%B %d, %Y")`
  |
  | Table of Contents:
output: 
  html_document:
    df_print: paged
    theme: cosmo
    toc: true
---

<br>

## 1. Backgound

Code to analyse TB case notification rates in Blantyre, Malawi: 2009-2018. 


<br>

## 2. Set-up

Load all required packages for analysis.

```{r setup, message=FALSE, comment=NA, warning=FALSE}
library(tidyverse)
install.packages("tidybayes")
library(tidybayes)
library(TBtrends)
library(knitr)
library(ggalt)
install.packages("ggtext")
library(ggtext)
library(ggseas)
library(pmthemes)
library(lubridate)
library(ciTools)
library(janitor)

```

<br>

## 3. Import datasets

Import the required datasets from the package (note these were cleaned and created in the `data-raw` folder)

```{r}
#numerators - TB cases
tb_cases_2011_2018 <- tb_cases_2011_2018
acf_cnrs_overall <- acf_cnrs_overall
acf_smrpos_cnrs_overall <- acf_smrpos_cnrs_overall
blantyre_census_by_q <- blantyre_census_by_q
acf_period_cnrs <- acf_period_cnrs
blantyre_census_2008_2018 <- blantyre_census_2008_2018 

```


<br>

## 4. Exploratory analysis

### 4.1. Overall trends in TB cases, by case characteristics

First, look at the numbers of TB case notifications, stratified by key characteristics

How many cases were registered between 2009 and 2011?

```{r}

acf_cnrs_overall %>%
  summarise(cases=sum(cases))

acf_cnrs_overall %>%
  group_by(acf) %>%
  summarise(cases=sum(cases))

```




Overall trends

```{r, fig.height=6, fig.width=10}

tb_cases_2011_2018 %>%
  filter(!is.na(smr_xpert_culture_any)) %>%
  group_by(year_q, smr_xpert_culture_any) %>%
  summarise(sum = n()) %>%
  ggplot() +
  geom_line(aes(x=year_q, y=sum, group=smr_xpert_culture_any, colour=smr_xpert_culture_any)) +
  geom_point(aes(x=year_q, y=sum, group=smr_xpert_culture_any, colour=smr_xpert_culture_any)) +
  theme_bw(base_family = "Open Sans Condensed Light",
           base_size = 16) +
  theme(axis.text.x=element_text(angle=90, hjust=1)) +
  labs(title = "TB case notifications",
       subtitle = "By microbiological status",
       x="",
       y="Number of cases") +
  theme(legend.title = element_blank(),
      legend.position=c(.85,.90),
      legend.background = element_blank())

ggsave(here::here("plots/fig1a.pdf"), height=6, width=10, device = cairo_pdf, dpi=600)

```

<br> 

By sex

```{r, fig.height=6, fig.width=10}

tb_cases_2011_2018 %>%
  filter(!is.na(smr_xpert_culture_any)) %>%
  group_by(year_q, sex, smr_xpert_culture_any) %>%
  summarise(sum = n()) %>%
  ggplot() +
  geom_line(aes(x=year_q, y=sum, group=sex, colour=sex)) +
  geom_point(aes(x=year_q, y=sum, group=sex, colour=sex)) +
  theme_bw(base_family = "Open Sans Condensed Light",
           base_size = 16) +
  theme(axis.text.x=element_text(angle=90, hjust=1)) +
  labs(title = "TB case notifications",
       subtitle = "By sex & microbiological status",
       x="",
       y="Number of cases") +
  theme(legend.title = element_blank(),
      legend.position=c(.90,.95),
      legend.background = element_blank()) +
  facet_grid(smr_xpert_culture_any~.)

ggsave(here::here("plots/fig1b.pdf"), height=6, width=10, device = cairo_pdf, dpi=600)


```

<br>

By age group

```{r, fig.height=6, fig.width=10}

tb_cases_2011_2018 %>%
    filter(!is.na(smr_xpert_culture_any)) %>%
  mutate(agegp=factor(agegp)) %>%
  mutate(agegp = case_when(agegp==1 ~ "16-19",
                           agegp==2 ~ "20-29",
                           agegp==3 ~ "30-39",
                           agegp==4 ~ "40-49",
                           agegp==5 ~ "50+")) %>%
  group_by(year_q, agegp, smr_xpert_culture_any) %>%
  summarise(sum = n()) %>%
  ggplot() +
  geom_line(aes(x=year_q, y=sum, group=agegp, colour=agegp)) +
  geom_point(aes(x=year_q, y=sum, group=agegp, colour=agegp)) +
  theme_bw(base_family = "Open Sans Condensed Light",
           base_size = 16) +
  theme(axis.text.x=element_text(angle=90, hjust=1)) +
  labs(title = "TB case notifications",
       subtitle = "By age group & microbiological status",
       x="",
       y="Number of cases") +
  theme(legend.title = element_blank(),
      legend.background = element_blank()) +
  facet_grid(smr_xpert_culture_any~.)

ggsave(here::here("plots/fig1c.pdf"), height=6, width=10, device = cairo_pdf, dpi=600)


```

<br>

By HIV status


```{r, fig.height=6, fig.width=10}

tb_cases_2011_2018 %>%
  filter(!is.na(smr_xpert_culture_any)) %>%
  group_by(year_q, hiv, smr_xpert_culture_any) %>%
  summarise(sum = n()) %>%
  ungroup() %>%
  mutate(hiv=case_when(is.na(hiv) ~ "c) Not tested",
                       TRUE ~ hiv)) %>%
  ggplot() +
  geom_line(aes(x=year_q, y=sum, group=hiv, colour=hiv)) +
  geom_point(aes(x=year_q, y=sum, group=hiv, colour=hiv)) +
  theme_bw(base_family = "Open Sans Condensed Light",
           base_size = 16) +
  theme(axis.text.x=element_text(angle=90, hjust=1)) +
  labs(title = "TB case notifications",
       subtitle = "By HIV status & microbiological status",
       x="",
       y="Number of cases") +
  theme(legend.title = element_blank()) +
  facet_grid(smr_xpert_culture_any~.)

ggsave(here::here("plots/fig1d.pdf"), height=6, width=10, device = cairo_pdf, dpi=600)


```

<br>

By routine health system sputum smear status

```{r, fig.height=6, fig.width=10}

tb_cases_2011_2018 %>%
  filter(!is.na(smr_xpert_culture_any)) %>%
  group_by(year_q, smr_clinic, smr_xpert_culture_any) %>%
  summarise(sum = n()) %>%
  ungroup() %>%
  mutate(smr_clinic = case_when(is.na(smr_clinic) ~ "c) Not tested",
                                TRUE ~ smr_clinic)) %>%
  ggplot() +
  geom_line(aes(x=year_q, y=sum, group=smr_clinic, colour=smr_clinic)) +
  geom_point(aes(x=year_q, y=sum, group=smr_clinic, colour=smr_clinic)) +
  theme_bw(base_family = "Open Sans Condensed Light",
           base_size = 16) +
  theme(axis.text.x=element_text(angle=90, hjust=1)) +
  labs(title = "TB case notification,",
       subtitle = " By clinic sputum smear status & microbiological status",
       x="",
       y="Number of cases") +
  theme(legend.title = element_blank()) +
  facet_grid(smr_xpert_culture_any~.)

ggsave(here::here("plots/fig1e.pdf"), height=6, width=10, device = cairo_pdf, dpi=600)


```

<br>

By research lab enhanced TB surveillance lab sputum sample smear status
(Note only started testing these in 2011)

```{r, fig.height=6, fig.width=10}

tb_cases_2011_2018 %>%
  filter(year>=2011) %>%
  group_by(year_q, smr_lab) %>%
  summarise(sum = n()) %>%
  mutate(smr_lab = case_when(is.na(smr_lab) ~ "c) Not tested",
                                TRUE ~ smr_lab)) %>%
  ggplot() +
  geom_line(aes(x=year_q, y=sum, group=smr_lab, colour=smr_lab)) +
  geom_point(aes(x=year_q, y=sum, group=smr_lab, colour=smr_lab)) +
  theme_bw(base_family = "Open Sans Condensed Light") +
  theme(axis.text.x=element_text(angle=45, hjust=1)) +
  labs(title = "TB case notifications, by research lab sputum smear status",
       subtitle = "Blantyre, Malawi: 2011-2018",
       caption = "Data: Blantyre Enhanced TB Surveillance",
       x="",
       y="Number of cases") +
  theme(legend.title = element_blank())

ggsave(here::here("plots/fig1f.pdf"), height=6, width=10, device = cairo_pdf, dpi=600)


```

<br>

By whether either clinic or research sputum sample was smear-positive

```{r, fig.height=6, fig.width=10}

tb_cases_2011_2018 %>%
  filter(year>=2011) %>%
  group_by(year_q, smr_xpert_any) %>%
  summarise(sum = n()) %>%
  mutate(smr_any = case_when(is.na(smr_xpert_any) ~ "c) Not tested",
                                TRUE ~ smr_xpert_any)) %>%
  ggplot() +
  geom_line(aes(x=year_q, y=sum, group=smr_xpert_any, colour=smr_xpert_any)) +
  geom_point(aes(x=year_q, y=sum, group=smr_xpert_any, colour=smr_xpert_any)) +
  theme_bw(base_family = "Open Sans Condensed Light",
           base_size = 16) +
  theme(axis.text.x=element_text(angle=45, hjust=1)) +
  labs(title = "TB case notification, by either clinic or lab smear status",
       x="",
       y="Number of cases") +
  theme(legend.title= element_blank(),
      legend.position=c(.85,.85)) +
  scale_x_discrete(breaks=c("2011.1", "2012.1", 
                            "2013.1", "2014.1", "2015.1", "2016.1",
                            "2017.1", "2018.1"),
                   labels=c("2011", "2012", 
                            "2013", "2014", "2015", "2016", "2017", "2018"))

ggsave(here::here("plots/fig1g.pdf"), height=6, width=8, device = cairo_pdf, dpi=600)


```

<br>

By age (in years)

```{r, fig.height=6, fig.width=10}

tb_cases_2011_2018 %>%
  filter(!is.na(smr_xpert_culture_any)) %>%
  ggplot(aes(x=year_q, y=age, smr_xpert_culture_any)) +
  stat_interval(.width = c(.1, .25, .5, .75, .9), size = 7) +
  scale_color_brewer(palette = "RdPu",
                     name="Quantile") +
  theme_bw(base_family = "Open Sans Condensed Light",
           base_size = 16) +
  theme(axis.text.x=element_text(angle=90, hjust=1)) +
  labs(title = "TB case notificaitons",
       subtitle = "By age & microbiological status",
       x="",
       y="Age (years)") +
  facet_grid(smr_xpert_culture_any~.)

ggsave(here::here("plots/fig1h.pdf"), height=6, width=10, device = cairo_pdf, dpi=600)


```

<br>

<br>

Not look at a moving average of notifications by smear status

```{r, fig.height=6, fig.width=10}

tb_cases_2011_2018 %>%
  filter(year >= "2011") %>%
  group_by(smr_any, year_week = floor_date(reg_date, "1 week")) %>%
  summarize(count = n()) %>%
  arrange(desc(count)) %>%
  ungroup() %>%
  mutate(smr_any = case_when(is.na(smr_any) ~ "c) Not tested",
                                TRUE ~ smr_any)) %>%
  ggplot() +
  geom_line(aes(x=year_week, y=count, colour = smr_any), alpha=0.3) +
  stat_rollapplyr(aes(x=year_week, y=count, colour = smr_any), width = 12, align = "center") +
  labs(title = "Numbers of notified TB cases per week and rolling average, by smear status",
       x="Week",
       y="Numbers of TB cases",
       subtitle = "Data from Blantyre Enhanced TB surveilance") +
  theme_minimal(base_family = "Open Sans Condensed Light") +
  theme(legend.title = element_blank()) +
  scale_color_brewer(palette = "Set1")

ggsave(here::here("plots/fig1j.pdf"), height=6, width=10, device = cairo_pdf, dpi=600)


```

<br>

Pulmonary vs. extrapulmonary

```{r}
tb_cases_2011_2018 %>%
  filter(!is.na(smr_xpert_culture_any)) %>%
  filter(year>=2011) %>%
  group_by(year_q, tbtype, smr_xpert_culture_any) %>%
  summarise(sum = n()) %>%
  filter(!is.na(tbtype)) %>%
  ggplot() +
  geom_line(aes(x=year_q, y=sum, group=tbtype, colour=tbtype)) +
  geom_point(aes(x=year_q, y=sum, group=tbtype, colour=tbtype)) +
  theme_bw(base_family = "Open Sans Condensed Light",
           base_size = 16) +
  theme(axis.text.x=element_text(angle=90, hjust=1)) +
  labs(title = "TB case notification",
       subtitle = "By TB classification & microbiological status",
       x="",
       y="Number of cases") +
  theme(legend.title= element_blank()) +
  scale_x_discrete(breaks=c("2011.1", "2012.1", 
                            "2013.1", "2014.1", "2015.1", "2016.1",
                            "2017.1", "2018.1"),
                   labels=c("2011", "2012", 
                            "2013", "2014", "2015", "2016", "2017", "2018")) +
  facet_grid(smr_xpert_culture_any~.)

ggsave(here::here("plots/fig1k.pdf"), height=6, width=10, device = cairo_pdf, dpi=600)
```

```{r}
tb_cases_2011_2018 %>%
  filter(year>=2011) %>%
  filter(!is.na(smr_xpert_culture_any)) %>%
  filter(hiv=="b) HIV-positive") %>%
  group_by(year_q, art, smr_xpert_culture_any) %>%
  summarise(sum = n()) %>%
  filter(!is.na(art)) %>%
  ggplot() +
  geom_line(aes(x=year_q, y=sum, group=art, colour=art)) +
  geom_point(aes(x=year_q, y=sum, group=art, colour=art)) +
  theme_bw(base_family = "Open Sans Condensed Light",
           base_size = 16) +
  theme(axis.text.x=element_text(angle=45, hjust=1)) +
  labs(title = "TB case notification",
       subtitle = "By ART status & microbiological status",
       x="",
       y="Number of cases") +
  theme(legend.title= element_blank()) +
  scale_x_discrete(breaks=c("2011.1", "2012.1", 
                            "2013.1", "2014.1", "2015.1", "2016.1",
                            "2017.1", "2018.1"),
                   labels=c("2011", "2012", 
                            "2013", "2014", "2015", "2016", "2017", "2018")) +
  facet_grid(smr_xpert_culture_any~.)

ggsave(here::here("plots/fig1l.pdf"), height=6, width=10, device = cairo_pdf, dpi=600)


```

```{r}
tb_cases_2011_2018 %>%
  filter(year>=2011) %>%
  filter(hiv == "b) HIV-positive") %>%
  filter(!is.na(smr_xpert_culture_any)) %>%
  group_by(year_q, art, smr_xpert_culture_any) %>%
  summarise(sum = n()) %>%
  filter(!is.na(art)) %>%
  group_by(year_q, smr_xpert_culture_any) %>%
  mutate(pct = sum/sum(sum)) %>%
  ggplot() +
  geom_bar(aes(x=year_q, y=pct, group=art, fill=art), stat = "identity") +
  scale_fill_brewer(palette = "RdPu") +
  scale_y_continuous(labels=scales::percent) +
  theme_bw(base_family = "Open Sans Condensed Light",
           base_size = 16) +
  labs(title = "ART coverage among HIV+ve TB cases at treatment initiation",
       y="",
       x="") +
  theme(legend.position = "none") +
  scale_x_discrete(breaks=c("2011.1", "2012.1", 
                            "2013.1", "2014.1", "2015.1", "2016.1",
                            "2017.1", "2018.1"),
                   labels=c("2011", "2012", 
                            "2013", "2014", "2015", "2016", "2017", "2018")) +
  facet_grid(smr_xpert_culture_any~.)

ggsave(here::here("plots/fig1m.pdf"), height=6, width=10, device = cairo_pdf, dpi=600)


```

```{r}
tb_cases_2011_2018 %>%
  filter(year>=2011) %>%
  filter(!is.na(hiv)) %>%
  filter(!is.na(smr_xpert_culture_any)) %>%
  group_by(year_q, hiv, smr_xpert_culture_any) %>%
  summarise(sum = n()) %>%
  group_by(year_q, smr_xpert_culture_any) %>%
  mutate(pct = sum/sum(sum)) %>%
  ggplot() +
  geom_bar(aes(x=year_q, y=pct, group=hiv, fill=hiv), stat = "identity") +
  geom_hline(aes(yintercept=max(pct)), linetype="dashed") +
  scale_fill_brewer(palette = "BuGn") +
  scale_y_continuous(labels=scales::percent) +
  theme_bw(base_family = "Open Sans Condensed Light",
           base_size = 16) +
  labs(title = "HIV status among TB cases at treatment initiation",
       y="",
       x="") +
  theme(legend.position = "none") +
  scale_x_discrete(breaks=c("2011.1", "2012.1", 
                            "2013.1", "2014.1", "2015.1", "2016.1",
                            "2017.1", "2018.1"),
                   labels=c("2011", "2012", 
                            "2013", "2014", "2015", "2016", "2017", "2018")) +
  facet_grid(smr_xpert_culture_any~.)

ggsave(here::here("plots/fig1n.pdf"), height=6, width=10, device = cairo_pdf, dpi=600)


```


## 5.Census data

Look at the change in census populations by quarter.
[Note: this uses linear interpolation between Q1 2008 and Q4 2018]

```{r, fig.height=6, fig.width=10}

blantyre_census_by_q %>%
  filter(year_q=="2008.2" | year_q=="2018.2") %>%
  ggplot() +
  geom_line(aes(y=age, x=population), colour="grey", size=2) +
  geom_dumbbell(aes(y=age, x=population, xend=population,
                      colour=factor(year)), size=2) +
  theme_minimal(base_family = "Open Sans Condensed Light") +
  labs(title = "Change in population in Blantyre by age group and sex",
       subtitle = "2008 (red) to 2018 (blue)",
       y="",
       x="Population") +
  scale_x_continuous(labels = scales::comma) +
  facet_grid(district~sex, scales = "free_x") +
  theme(legend.position = "none")

ggsave(here::here("plots/fig2a.pdf"), height=6, width=8, device = cairo_pdf, dpi=600)

#Filter down to blantyre city only...

blantyre_census_by_q %>%
  filter(district=="Blantyre City") %>%
  filter(year_q=="2008.2" | year_q=="2018.2") %>%
  filter(sex!="Total") %>%
  ggplot() +
  geom_line(aes(y=age, x=population), colour="grey78", size=2) +
  geom_dumbbell(aes(y=age, x=population, xend=population,
                      colour=factor(year)), size=2) +
  theme_minimal(base_family = "Open Sans Condensed Light",
                base_size = 16) +
  labs(title = "Change in population in Blantyre City by age group and sex",
       subtitle = "2008 <b style='color:#A6CEE3'>(light blue)</b> to 2018 <b style='color:#1F78B4'>(dark blue)</b>",
       y="",
       x="Population") +
  scale_x_continuous(labels = scales::comma) +
  scale_colour_brewer(type="qual", palette = "Paired") +
  facet_grid(.~sex, scales = "free_x") +
  theme(legend.position = "none") +
  theme(
    plot.title = element_markdown(lineheight = 1),
        plot.subtitle = element_markdown(lineheight = 1)
  )

ggsave(here::here("plots/fig2b.pdf"), height=6, width=10, device = cairo_pdf, dpi=600)


#What has the population growth been in the adolescent/young adult age groups

filter_ages <- c("10-14", "15-19", "20-24", "25-29", "30-34", "35-39", "40-44")

blantyre_census_by_q %>%
  filter(district=="Blantyre City") %>%
  filter(year_q=="2008.2" | year_q=="2018.2") %>%
  filter(age %in% filter_ages) %>%
  group_by(year) %>%
  summarise(sum_pop = sum(population)) %>%
  mutate(change_pop = case_when(year=="2018" ~ (sum_pop-lag(sum_pop))/lag(sum_pop))*100)


```

<br> 

ACF population vs. non-ACF population

(i.e. Blantyre ACF area - Total Blantyre City population, with linear interpolition for growth for total population and ACF area to match and and age-group specific growth rates for 2008-2018)

```{r, fig.height=6, fig.width=10}
acf_pops <- acf_pops

acf_pops %>%
  ggplot() +
  geom_line(aes(x=year_q, y=population, group=age, colour=age)) +
  geom_point(aes(x=year_q, y=population, group=age, colour=age), alpha=0.3, size=0.5) +
  facet_wrap(acf~sex) +
  theme_bw(base_family = "Open Sans Condensed Light") +
  theme(axis.text.x=element_text(angle=45, hjust=1)) +
  scale_y_continuous(labels = scales::comma) +
  theme(panel.grid = element_blank(),
        legend.title = element_blank()) +
  labs(y="Population",
       x="",
       title="Interpolated change in Blantyre City population in ACF and non-ACF areas",
       subtitle = "2009-2018, by quarter")

ggsave(here::here("plots/fig2c.pdf"), height=6, width=10, device = cairo_pdf, dpi=600)


```

<br>

## 6. Case notification rates

Overall TB case notification rates stratified by ACF area

```{r, fig.height=6, fig.width=10}

acf_cnrs_overall <- acf_cnrs_overall

write.csv(acf_cnrs_overall, "acf_cnrs_overall.csv")

#get the ACF period
acf <- tb_cases_2011_2018 %>%
  select(year_q, period) %>%
  distinct() %>%
  arrange(year_q) %>%
  mutate(acf_tag = case_when(period=="pre-ACF" ~ NA_real_,
                             period=="ACF" ~ 0))

#Here are the data
acf_cnrs_overall %>% arrange(year_q)

acf_cnrs_overall %>%
  ggplot() +
  geom_vline(aes(xintercept =  22.95), linetype=4) +
  geom_vline(aes(xintercept =  10), linetype=4) +
  annotate("text", label="Active case finding period", x = 16, y = 30, size = 4) +
  geom_line(aes(x=year_q, y=cnr, 
                      ymin=conf.low, ymax=conf.high, 
                      group=acf, colour=acf), alpha=0.3, position = position_dodge(width = 0.2), linetype="dashed") +
  geom_pointrange(aes(x=year_q, y=cnr, 
                      ymin=conf.low, ymax=conf.high, 
                      group=acf, colour=acf), alpha=0.7, position = position_dodge(width = 0.2)) +
  geom_segment(data = acf, aes(x="2011.2", xend="2014.3", y=acf_tag, yend=acf_tag),
               size=2)+
  theme_bw(base_family = "Open Sans Condensed Light",
           base_size = 16) +
  theme(axis.text.x=element_text(angle=90, hjust=1)) +
  labs(title = "All TB cases notification rates in Blantyre City, Malawi",
       subtitle = "By active case finding area and quarter, 2009-2018",
       x="",
       y="TB case notification rate (per 100,000)\n95% confidence interval") +
  scale_x_discrete(breaks=c("2009.1","2010.1", "2011.1", "2012.1", 
                            "2013.1", "2014.1", "2015.1", "2016.1",
                            "2017.1", "2018.1"),
                   labels=c("2009","2010", "2011", "2012", 
                            "2013", "2014", "2015", "2016", "2017", "2018")) +
  scale_color_brewer(type="qual", palette = "Set1") +
  theme(legend.title = element_blank(),
      legend.position=c(.9,.9))
  
ggsave(here::here("plots/fig5a.pdf"), height=6, width=8, device = cairo_pdf, dpi=600)

```

<br>

Sputum smear positive case notification rates

```{r, fig.height=6, fig.width=10}

acf_smrpos_cnrs_overall <- acf_smrpos_cnrs_overall

write.csv(acf_smrpos_cnrs_overall, "acf_smrpos_cnrs_overall.csv")


#Here are the data
acf_smrpos_cnrs_overall %>% arrange(year_q)


acf_smrpos_cnrs_overall %>%
  ggplot() +
  geom_vline(aes(xintercept =  22.95), linetype=4) +
  geom_vline(aes(xintercept =  10), linetype=4) +
  annotate("text", label="Active case finding period", x = 16, y = 20, size = 4) +
  geom_line(aes(x=year_q, y=cnr, 
                      ymin=conf.low, ymax=conf.high, 
                      group=acf, colour=acf), alpha=0.3, position = position_dodge(width = 0.2)) +
  geom_pointrange(aes(x=year_q, y=cnr, 
                      ymin=conf.low, ymax=conf.high, 
                      group=acf, colour=acf), alpha=0.7, position = position_dodge(width = 0.2)) +
  geom_segment(data = acf, aes(x="2011.2", xend="2014.3", y=acf_tag, yend=acf_tag),
               size=2)+
  theme_bw(base_family = "Open Sans Condensed Light",
           base_size = 16) +
  theme(axis.text.x=element_text(angle=90, hjust=1)) +
  labs(title = "Smear/Xpert-positive TB case notification rates in Blantyre City, Malawi",
       subtitle = "By active case finding area and quarter, 2009-2018",
       x="",
       y="Smr/Xpert +ve TB case notification rate (per 100,000)\n95% confidence interval") +
  scale_x_discrete(breaks=c("2009.1", "2010.1", "2011.1", "2012.1", 
                            "2013.1", "2014.1", "2015.1", "2016.1",
                            "2017.1", "2018.1"),
                   labels=c("2009", "2010", "2011", "2012", 
                            "2013", "2014", "2015", "2016", "2017", "2018")) +
  scale_color_brewer(type="qual", palette = "Set1") +
  theme(legend.title = element_blank(),
      legend.position=c(.9,.9))
  
ggsave(here::here("plots/fig5b.pdf"), height=6, width=8, device = cairo_pdf, dpi=600)

```
(,
       caption = "Population denominators are from 2008 and 2018 Malawi census, with linear interpolation for quarterly estimates\nBlack line is period of TB active case-finding\nSmear- or Xpert-positive cases from samples tested by routine health system or research TB laboratory")

## 7. Age-sex disaggregated TB case notification rates

Now estimate case notifications for age and sex groups by quarter

First get the case notifications into age groups to match census.

```{r, fig.height=6, fig.width=10}

ageg_cases <- tb_cases_2011_2018  %>%
  select(year, quarter, year_q, age, sex) %>%
  mutate(sex = case_when(sex=="Male" ~ "Males",
                         sex=="Female" ~ "Females")) %>%
  mutate(age = case_when(age <=4 ~ "00-04",
                         age >=5 & age <=9 ~ "05-09",
                         age >=10 & age <=14 ~ "10-14",
                         age >=15 & age <=19 ~ "15-19",
                         age >=20 & age <=24 ~ "20-24",
                         age >=25 & age <=29 ~ "25-29",
                         age >=30 & age <=34 ~ "30-34",
                         age >=35 & age <=39 ~ "35-39",
                         age >=40 & age <=44 ~ "40-44",
                         age >=45 & age <=49 ~ "45-49",
                         age >=50 & age <=54 ~ "50-54",
                         age >=55 & age <=59 ~ "55-59",
                         age >=60 & age <=64 ~ "60-64",
                         age >=65 & age <=69 ~ "65-69",
                         age >=70 & age <=74 ~ "70-74",
                         age >=75 ~ "75+")) %>%
  group_by(year_q, sex, age) %>%
  count() %>%
  ungroup()


#sanity check - does the total = the summarised total

ageg_cases %>%
  ungroup() %>%
  summarise(sum = sum(n))
#YUP

```

<br>

Now merge to the census denominators

```{r, fig.height=6, fig.width=10}

acf_cnrs_age_sex <- left_join(acf_cnrs_age_sex, acf)


#Here is the raw data
acf_cnrs_age_sex %>% arrange(year_q)

#Now plot these
acf_cnrs_age_sex %>%
  ggplot() +
  geom_line(aes(x=year_q, y=cnr, colour=age, group=age), alpha=0.3) +
  geom_smooth(aes(x=year_q, y=cnr, colour=age, group=age)) +
  geom_segment(data = acf, aes(x="2011.2", xend="2014.3", y=acf_tag, yend=acf_tag),
               size=2)+
  facet_grid(sex~ age + acf) +
  theme_bw(base_family = "Open Sans Condensed Light") +
  theme(axis.text.x=element_text(angle=90, hjust=1)) +
  labs(title = "TB case notification rates in Blantyre City, Malawi",
       subtitle = "By ACF area, age group, sex, quarter, 2011-2018",
       x="",
       y="Case notification rate (per 100,000)",
       caption = "Population denominators are from 2008 and 2018 Malawi census, with linear interpolation for quarterly estimates\nBlack line is period of TB active case-finding\nTrend estimated by LOWESS") +
  theme(legend.position = "none") +
  scale_x_discrete(breaks=c("2009.1", "2012.1", "2015.1", "2018.1"),
                   labels=c("2009", "2012", "2015", "2018"))

ggsave(here::here("plots/fig3a.pdf"), height=6, width=10, device = cairo_pdf, dpi=600)


```

Look at the binomial distribution for each group


```{r, fig.height=6, fig.width=10}
acf_cnrs_age_sex <- acf_cnrs_age_sex

acf_cnrs_age_sex <- left_join(acf_cnrs_age_sex, acf)

acf_cnrs_age_sex %>%
  ggplot() +
  geom_pointrange(aes(x=year_q, y=cnr, 
                      ymin=conf.low, ymax=conf.high, 
                      group=acf, colour=acf), alpha=0.3, position = position_dodge(width = 0.2)) +
  geom_segment(data = acf, aes(x="2011.2", xend="2014.3", y=acf_tag, yend=acf_tag),
               size=2)+
  facet_grid(sex~ age + acf) +
  theme_bw(base_family = "Open Sans Condensed Light") +
  theme(axis.text.x=element_text(angle=90, hjust=1)) +
  labs(title = "TB case notification rates in Blantyre City, Malawi",
       subtitle = "By ACF area, age group, sex, quarter, 2009-2018",
       x="",
       y="Case notification rate (per 100,000)",
       caption = "Population denominators are from 2008 and 2018 Malawi census, with linear interpolation for quarterly estimates\nBlack line is period of TB active case-finding\nTrend estimated by LOWESS") +
  theme(legend.position = "none") +
  scale_x_discrete(breaks=c("2009.1", "2012.1", "2015.1", "2018.1"),
                   labels=c("2009", "2012", "2015", "2018")) +
  scale_color_brewer(type="qual", palette = "Set1")

ggsave(here::here("plots/fig3b.pdf"), height=6, width=10, device = cairo_pdf, dpi=600)
```

<br>

Now the same, but for smear-positive case notification rates

```{r, fig.height=6, fig.width=10}

acf_smrpos_cnrs_age_sex <- acf_smrpos_cnrs_age_sex

#Here is the raw data
acf_smrpos_cnrs_age_sex %>% arrange(year_q)


acf_smrpos_cnrs_age_sex %>%
  ggplot() +
  geom_line(aes(x=year_q, y=cnr, colour=age, group=age), alpha=0.3) +
  geom_smooth(aes(x=year_q, y=cnr, colour=age, group=age)) +
  geom_segment(data = acf, aes(x="2011.2", xend="2014.3", y=acf_tag, yend=acf_tag),
               size=2)+
  facet_grid(sex~age+acf) +
  theme_bw(base_family = "Open Sans Condensed Light") +
  theme(axis.text.x=element_text(angle=90, hjust=1)) +
  labs(title = "Sputum smear positive TB case notification rates in Blantyre City, Malawi",
       subtitle = "By ACF area, age group, sex and quarter, 2011-2018",
       x="",
       y="Case notification rate (per 100,000)",
       caption = "Population denominators are from 2008 and 2018 Malawi census, with linear interpolation for quarterly estimates\nBlack line is period of TB active case-finding\nTrend estimated by LOWESS\nSputum samples not taken for participants aged 0-14 years old") +
  theme(legend.position = "none") +
  scale_x_discrete(breaks=c("2009.1", "2012.1", "2015.1", "2018.1"),
                   labels=c("2009", "2012", "2015", "2018")) +
  scale_color_brewer(type="qual", palette = "Set1")

ggsave(here::here("plots/fig3c.pdf"), height=6, width=10, device = cairo_pdf, dpi=600)


```

<br>

Now using the binomial distribution for smear-postive cases


```{r, fig.height=6, fig.width=10}

acf_smrpos_cnrs_age_sex <- acf_smrpos_cnrs_age_sex

acf_smrpos_cnrs_age_sex %>%
  ggplot() +
  geom_pointrange(aes(x=year_q, y=cnr, 
                      ymin=conf.low, ymax=conf.high, 
                      group=acf, colour=acf), alpha=0.3, position = position_dodge(width = 0.2)) +
  geom_segment(data = acf, aes(x="2011.2", xend="2014.3", y=acf_tag, yend=acf_tag),
               size=2) +
  facet_grid(sex~age+acf) +
  theme_bw(base_family = "Open Sans Condensed Light") +
  theme(axis.text.x=element_text(angle=90, hjust=1)) +
  labs(title = "Sputum smear positive TB case notification rates in Blantyre City, Malawi",
       subtitle = "By ACF area, age group, sex and quarter, 2009-2018",
       x="",
       y="Case notification rate (per 100,000)",
       caption = "Population denominators are from 2008 and 2018 Malawi census, with linear interpolation for quarterly estimates\nBlack line is period of TB active case-finding\nTrend estimated by LOWESS\nSputum samples not taken for participants aged 0-14 years old") +
  theme(legend.position = "none") +
  scale_x_discrete(breaks=c("2009.1", "2012.1", "2015.1", "2018.1"),
                   labels=c("2009", "2012", "2015", "2018")) +
  scale_color_brewer(type="qual", palette = "Set1")

ggsave(here::here("plots/fig3d.pdf"), height=6, width=10, device = cairo_pdf, dpi=600)


```

<br>

## 8. HIV-positive CNRs

Estimate HIV statified case notification rates

```{r, fig.height=6, fig.width=10}

hiv_cnrs <- hiv_cnrs

#Here are the data
hiv_cnrs %>% arrange(year_q)

hiv_cnrs %>%
  ggplot() +
  geom_line(aes(x=year_q, y=hiv_cnr, colour=age, group=age), alpha=0.3) +
  geom_smooth(aes(x=year_q, y=hiv_cnr, colour=age, group=age)) +
  geom_segment(data = acf, aes(x="2011.2", xend="2014.3", y=acf_tag, yend=acf_tag),
               size=2)+
  facet_grid(sex + hiv ~ age) +
  theme_bw(base_family = "Open Sans Condensed Light") +
  theme(axis.text.x=element_text(angle=90, hjust=1)) +
  labs(title = "TB case notification rates in Blantyre City, Malawi",
       subtitle = "By HIV status, age group, sex and quarter, 2011-2018",
       x="",
       y="TB case notification rate (per 100,000)",
       caption = "Population denominators are from 2008 and 2018 Malawi census, with linear interpolation for quarterly estimates\nHIV prevalence from HitTB HIV prevalence survey\nBlack line is period of TB active case-finding\nTrend estimated by LOWESS") +
  theme(legend.position = "none") +
  scale_x_discrete(breaks=c("2009.1", "2012.1", "2015.1", "2018.1"),
                   labels=c("2009", "2012", "2015", "2018"))

ggsave(here::here("plots/fig4a.pdf"), height=6, width=10, device = cairo_pdf, dpi=600)


```

<br>

## 8. Overall CNRs, with population demoninators

```{r}

culture_cases<- tb_cases_2011_2018 %>%
  filter(!is.na(smr_xpert_culture_any)) %>%
  group_by(year_q, smr_xpert_culture_any) %>%
  count()

culture_denoms <- blantyre_census_by_q %>%
  filter(district=="Blantyre City") %>%
  filter(sex !="total") %>%
  filter(year_q>="2011.2") %>%
  group_by(year_q) %>%
  summarise(population = sum(population))

culture_cnrs <- left_join(culture_cases, culture_denoms)


culture_cnrs %>%
  group_by(year_q) %>%
  mutate(q_population = round(population/4)) %>%
  mutate(cnr = (n/q_population*100000)) %>%
  rowwise %>%
  mutate(xx = list(broom::tidy(binom.test(n, q_population, conf.level=0.95)))) %>%
  tidyr::unnest(xx) %>%
  ungroup() %>%
  mutate_at(vars(estimate, conf.low, conf.high), funs(.*100000)) %>%
  select(-estimate, -statistic, - p.value, -method, -alternative, -parameter) %>%
  ggplot() +
  geom_ribbon(aes(x=year_q, ymin=conf.low, ymax=conf.high, group=0), fill="grey70", alpha=0.5) +
  geom_line(aes(x=year_q, y=cnr, group=smr_xpert_culture_any, colour=smr_xpert_culture_any))+
  geom_point(aes(x=year_q, y=cnr, group=smr_xpert_culture_any, colour=smr_xpert_culture_any))+
  theme_bw(base_family = "Open Sans Condensed Light",
           base_size = 16) +
  theme(axis.text.x=element_text(angle=90, hjust=1)) +
  labs(title = "TB case notification rate in Blantyre City, Malawi",
       x="",
     y="TB case notification rate (per 100,000)\n95% confidence interval") +
  theme(legend.position = "none") +
  scale_x_discrete(breaks=c("2009.1","2010.1", "2011.1", "2012.1", 
                            "2013.1", "2014.1", "2015.1", "2016.1",
                            "2017.1", "2018.1"),
                   labels=c("2009","2010", "2011", "2012", 
                            "2013", "2014", "2015", "2016", "2017", "2018")) +
  facet_grid(smr_xpert_culture_any~.)

ggsave(here::here("plots/fig6a.pdf"), height=6, width=10, device = cairo_pdf, dpi=600)


```

CNRs by ACF period

```{r}
acf_period_cnrs %>%
  mutate(period2 = factor(period2)) %>%
  mutate(sex = case_when(sex=="Male" ~ "Men",
                         sex=="Female" ~ "Women")) %>%
  ggplot() +
  geom_pointrange(aes(x=fct_relevel(period2,
                               "Pre-ACF", "ACF", "Post-ACF: y1", "Post-ACF: y2"), y=cnr, 
                      ymin=conf.low, ymax=conf.high,
                      colour=acf, group=acf, shape=acf), position = position_dodge(width = 0.5)) +
  facet_grid(fct_relevel(sex, "Men", "Women") ~agegp, scales = "free_x") +
  theme_bw(base_family = "Helvetica",
           base_size = 14) +
  labs(x="",
       y="Smear/Xpert-positive CNR (per 100,000)\n95% confidence interval") +
  scale_color_brewer(type="qual", palette = "Set1") +
  theme(axis.text.x=element_text(angle=90, hjust=1)) +
  theme(legend.title = element_blank(),
      legend.position=c(0.085,.9),
      legend.background = element_blank()) +
  theme(panel.grid.major = element_line(colour="grey75", size=0.15)) +
  theme(axis.line.x = element_line(colour="black", size=0.5, linetype = "solid")) +
  theme(strip.background = element_rect(fill=NA))

ggsave(here::here("plots/fig7a.pdf"), height=6, width=10, device = cairo_pdf, dpi=600)


```



## 10. Reproducibility

This reproduction of the analysis was run by: 

```{r sysinfo, echo=FALSE, message=FALSE, comment=NA, warning=FALSE}

sysinfo <- Sys.info()

sysinfo <- data.frame(keyName=names(sysinfo), value=sysinfo, row.names=NULL)

sysinfo %>% kable()
```

Analysis was run at **`r Sys.time()`**, and using the following Session Info:

```{r sessioninfo, echo=FALSE, results='markdown', message=FALSE, comment=NA, warning=FALSE}
sessionInfo()
```
